<!doctype html><html lang=en><head><meta charset=utf-8><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content="light dark" name=color-scheme><title>Why robotics needs determinism</title><link href=/img/favicon-32x32.png rel=icon sizes=32x32 type=image/png><link href=/img/favicon-16x16.png rel=icon sizes=16x16 type=image/png><link href=/img/apple-touch-icon.png rel=apple-touch-icon sizes=180x180><style>body{--primary-color:#5871a2;--primary-pale-color:#5871a210;--text-color:#3c4043;--text-pale-color:#94969f;--bg-color:#fff;--highlight-mark-color:#5f75b035;--callout-note-color:#5871a2;--callout-important-color:#8062b0;--callout-warning-color:#936e51;--callout-alert-color:#bc5252;--callout-question-color:#477389;--callout-tip-color:#3c8460}body.dark{--primary-color:#5d77ac;--primary-pale-color:#5d77ac20;--text-color:#9197a5;--text-pale-color:#747983;--bg-color:#202124;--highlight-mark-color:#5f75b035;--callout-note-color:#5d77ac;--callout-important-color:#8062b0;--callout-warning-color:#936e51;--callout-alert-color:#bc5252;--callout-question-color:#477389;--callout-tip-color:#3c8460}body{--main-font:ui-sans-serif,system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";--code-font:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;--homepage-max-width:768px;--main-max-width:768px;--avatar-size:60px;--icon-size:20px;--homepage-font-size:16px;--homepage-line-height:1.75;--paragraph-font-size:16px;--paragraph-line-height:1.75;--aside-font-size:15px;--img-border-radius:0;--callout-border-radius:0;--detail-border-radius:0;--dark-mode-img-brightness:.75;--dark-mode-chart-brightness:.75;--inline-code-border-radius:2px;--inline-code-bg-color:var(--primary-pale-color);--block-code-border-radius:0;--block-code-border-color:var(--primary-color);--detail-border-color:var(--primary-color)}</style><link href=/main.css rel=stylesheet><link href=/hl-light.css id=hl rel=stylesheet><body class=post><script>const theme=sessionStorage.getItem('theme');const match=window.matchMedia("(prefers-color-scheme: dark)").matches;if(theme&&theme=='dark'||!theme&&match){document.body.classList.add('dark');const a=document.querySelector('link#hl');if(a)a.href='/hl-dark.css'}</script><header class=blur><div id=header-wrapper><nav><a class=instant href=/>stu</a><span class=separator>::</span><a class=instant href=/blog>blog</a></nav><div id=btns><a aria-label="rss feed" href=/blog/feed.xml id=rss-btn><svg viewbox="0 0 24 24" height=20 width=20 xmlns=http://www.w3.org/2000/svg><path d="M3 17C5.20914 17 7 18.7909 7 21H3V17ZM3 10C9.07513 10 14 14.9249 14 21H12C12 16.0294 7.97056 12 3 12V10ZM3 3C12.9411 3 21 11.0589 21 21H19C19 12.1634 11.8366 5 3 5V3Z" fill=currentColor></path></svg></a><button aria-label="theme switch" data-moon-icon='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="20" height="20"><path d="M10 7C10 10.866 13.134 14 17 14C18.9584 14 20.729 13.1957 21.9995 11.8995C22 11.933 22 11.9665 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12C2 6.47715 6.47715 2 12 2C12.0335 2 12.067 2 12.1005 2.00049C10.8043 3.27098 10 5.04157 10 7ZM4 12C4 16.4183 7.58172 20 12 20C15.0583 20 17.7158 18.2839 19.062 15.7621C18.3945 15.9187 17.7035 16 17 16C12.0294 16 8 11.9706 8 7C8 6.29648 8.08133 5.60547 8.2379 4.938C5.71611 6.28423 4 8.9417 4 12Z" fill="currentColor"></path></svg>' data-sun-icon='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="20" height="20"><path d="M12 18C8.68629 18 6 15.3137 6 12C6 8.68629 8.68629 6 12 6C15.3137 6 18 8.68629 18 12C18 15.3137 15.3137 18 12 18ZM12 16C14.2091 16 16 14.2091 16 12C16 9.79086 14.2091 8 12 8C9.79086 8 8 9.79086 8 12C8 14.2091 9.79086 16 12 16ZM11 1H13V4H11V1ZM11 20H13V23H11V20ZM3.51472 4.92893L4.92893 3.51472L7.05025 5.63604L5.63604 7.05025L3.51472 4.92893ZM16.9497 18.364L18.364 16.9497L20.4853 19.0711L19.0711 20.4853L16.9497 18.364ZM19.0711 3.51472L20.4853 4.92893L18.364 7.05025L16.9497 5.63604L19.0711 3.51472ZM5.63604 16.9497L7.05025 18.364L4.92893 20.4853L3.51472 19.0711L5.63604 16.9497ZM23 11V13H20V11H23ZM4 11V13H1V11H4Z" fill="currentColor"></path></svg>' id=theme-toggle><svg viewbox="0 0 24 24" height=20 width=20 xmlns=http://www.w3.org/2000/svg><path d="M10 7C10 10.866 13.134 14 17 14C18.9584 14 20.729 13.1957 21.9995 11.8995C22 11.933 22 11.9665 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12C2 6.47715 6.47715 2 12 2C12.0335 2 12.067 2 12.1005 2.00049C10.8043 3.27098 10 5.04157 10 7ZM4 12C4 16.4183 7.58172 20 12 20C15.0583 20 17.7158 18.2839 19.062 15.7621C18.3945 15.9187 17.7035 16 17 16C12.0294 16 8 11.9706 8 7C8 6.29648 8.08133 5.60547 8.2379 4.938C5.71611 6.28423 4 8.9417 4 12Z" fill=currentColor></path></svg></button><button aria-label="table of content" id=toc-toggle><svg viewbox="0 0 24 24" height=20 width=20 xmlns=http://www.w3.org/2000/svg><path d="M3 4H21V6H3V4ZM3 11H15V13H3V11ZM3 18H21V20H3V18Z" fill=currentColor></path></svg></button></div></div></header><dialog id=rss-mask><div><a href=https://stuglaser.github.io/blog/feed.xml>https://stuglaser.github.io/blog/feed.xml</a><button data-check-icon='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="20" height="20"><path d="M10.0007 15.1709L19.1931 5.97852L20.6073 7.39273L10.0007 17.9993L3.63672 11.6354L5.05093 10.2212L10.0007 15.1709Z" fill="currentColor"></path></svg>' data-copy-icon='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="20" height="20"><path d="M6.9998 6V3C6.9998 2.44772 7.44752 2 7.9998 2H19.9998C20.5521 2 20.9998 2.44772 20.9998 3V17C20.9998 17.5523 20.5521 18 19.9998 18H16.9998V20.9991C16.9998 21.5519 16.5499 22 15.993 22H4.00666C3.45059 22 3 21.5554 3 20.9991L3.0026 7.00087C3.0027 6.44811 3.45264 6 4.00942 6H6.9998ZM5.00242 8L5.00019 20H14.9998V8H5.00242ZM8.9998 6H16.9998V16H18.9998V4H8.9998V6Z" fill="currentColor"></path></svg>' aria-label=copy autofocus data-link=https://stuglaser.github.io/blog/feed.xml><svg viewbox="0 0 24 24" height=20 width=20 xmlns=http://www.w3.org/2000/svg><path d="M6.9998 6V3C6.9998 2.44772 7.44752 2 7.9998 2H19.9998C20.5521 2 20.9998 2.44772 20.9998 3V17C20.9998 17.5523 20.5521 18 19.9998 18H16.9998V20.9991C16.9998 21.5519 16.5499 22 15.993 22H4.00666C3.45059 22 3 21.5554 3 20.9991L3.0026 7.00087C3.0027 6.44811 3.45264 6 4.00942 6H6.9998ZM5.00242 8L5.00019 20H14.9998V8H5.00242ZM8.9998 6H16.9998V16H18.9998V4H8.9998V6Z" fill=currentColor></path></svg></button></div></dialog><div id=wrapper><div id=blank></div><aside><nav><ul><li><a class=h2 href=#determinism-in-robotics-software>Determinism in robotics software</a><li><a class=h2 href=#types-of-reproducibility-goals>Types of reproducibility goals</a><li><a class=h2 href=#why-does-dev-non-determinism-happen>Why does dev non-determinism happen?</a><li><a class=h2 href=#how-to-get-reproducibility>How to get reproducibility?</a><li><a class=h2 href=#what-software-to-use>What software to use</a></ul></nav></aside><main><div><div data-check-icon='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="20" height="20"><path d="M10.0007 15.1709L19.1931 5.97852L20.6073 7.39273L10.0007 17.9993L3.63672 11.6354L5.05093 10.2212L10.0007 15.1709Z" fill="currentColor"></path></svg>' data-copy-icon='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="20" height="20"><path d="M6.9998 6V3C6.9998 2.44772 7.44752 2 7.9998 2H19.9998C20.5521 2 20.9998 2.44772 20.9998 3V17C20.9998 17.5523 20.5521 18 19.9998 18H16.9998V20.9991C16.9998 21.5519 16.5499 22 15.993 22H4.00666C3.45059 22 3 21.5554 3 20.9991L3.0026 7.00087C3.0027 6.44811 3.45264 6 4.00942 6H6.9998ZM5.00242 8L5.00019 20H14.9998V8H5.00242ZM8.9998 6H16.9998V16H18.9998V4H8.9998V6Z" fill="currentColor"></path></svg>' id=copy-cfg style=display:none></div><article data-backlink-icon='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="20" height="20"><path d="M9.41421 8L18.0208 16.6066L16.6066 18.0208L8 9.41421V17H6V6H17V8H9.41421Z" fill="currentColor"></path></svg>' class=prose><h1>Why robotics needs determinism</h1><div id=post-info><div id=date><span id=publish>2024-04-30</span></div><div id=tags><a class=instant href=https://stuglaser.github.io/tags/time><span>#</span>time</a></div></div><h1 id=determinism-in-robotics-software>Determinism in robotics software<a aria-label="Anchor link for: determinism-in-robotics-software" class=zola-anchor href=#determinism-in-robotics-software style=visibility:hidden>#</a></h1><p>It’s a lot harder to debug something when it gives different results each time you run it. Robotics software is almost predetermined to be a non-reproducible nightmare. There is multithreading, lots of floating point math, and unusual hardware architectures, all of which harm the reproducibility of code. In a typical robotics project, it’s very common to run the same code on the same data and get very different results.<h1 id=types-of-reproducibility-goals>Types of reproducibility goals<a aria-label="Anchor link for: types-of-reproducibility-goals" class=zola-anchor href=#types-of-reproducibility-goals style=visibility:hidden>#</a></h1><p>There are two possible goals of reproducibility:<ol><li>Onboard reproducibility: Reproducing a situation that happened on your robot precisely on a developer machine.<li>Dev reproducibility: Running the same software on a developer’s machine produces the same results every time, but doesn’t necessarily reproduce the onboard results.</ol><p>Dev reproducibility is very important for having a sane development process. Without dev reproducibility, every test is flakey. Debugging problems is extremely difficult, because adding log statements to code and rerunning it will give a different result. It’s even difficult to try out new ideas in a given component, since upstream components may produce varying outputs.<p>Onboard reproducibility is nice too, but it is very difficult to achieve. The onboard software gets run as quickly as possible, so messages can get dropped and execution of components can be reordered. To get onboard-to-offboard reproducibility, all message passing events must be memorized and replayed. Even worse, if a message is received by an onboard component, but not saved to disk, it cannot be replayed and reproducibility of this example is impossible. Differences in CPU or GPU can cause differences in floating point computations. Getting onboard code to reproduce perfectly offboard is very very difficult.<p>But onboard reproducibility may not be a necessary goal. Some code has probably already changed from when the robot ran to when the debugging is happening, so reproducing the onboard event precisely tells you nothing about what the current code (which hopefully has some fixes and improvements) would do. Instead, the events that matter are the ones that still fail on the current code, and debugging those only needs dev reproducibility.<h1 id=why-does-dev-non-determinism-happen>Why does dev non-determinism happen?<a aria-label="Anchor link for: why-does-dev-non-determinism-happen" class=zola-anchor href=#why-does-dev-non-determinism-happen style=visibility:hidden>#</a></h1><p><img alt=component-graph src=https://stuglaser.github.io/blog/why-determinism/component_graph.png><p>Typically, robotics software is made of a bunch of nodes that pass messages to each other, mostly sending messages in one direction from upstream sensor components, to perception components, to planner components, and then to controllers. Each component receives some messages, runs, and sends out messages to its downstream consumers. The main cause of nondeterminism is that the first time we replay a situation, a component receives a certain set of messages, but the next replay it receives a different set. For example, at timestep T=90, node C may receive (A_90, B_90), but on the second replay it may receive (A_90, B_91), or even (A_90, <em>dropped</em>).<p>Onboard, this kind of nondeterminism is expected. Messages can arrive slightly early or slightly late, and since components should not wait too long to execute, on some time steps they may miss certain messages.<p>It is also possible to have nondeterminism within a given component. Typical issues include not seeding a random number generator, being overly clever with multithreading inside the component, using data structures that are non-deterministic themselves, and using wall time (which we’ll discuss later). Non determinism within a component is a lot easier to track down than issues from message passing, since it’s self-contained and can be debugged without involving the rest of the system.<h1 id=how-to-get-reproducibility>How to get reproducibility?<a aria-label="Anchor link for: how-to-get-reproducibility" class=zola-anchor href=#how-to-get-reproducibility style=visibility:hidden>#</a></h1><p>To get reproducibility, your robotics framework needs, for each component, to control the order of messages presented to that component. As long as the order of presented messages is deterministic (and the component is internally deterministic), then your overall simulation should be deterministic.<p>The least error-prone way I can think of to get determinism is that each component has its own independent clock, which behaves similar to the logical clock concept in distributed systems. Every time the framework passes a message, it also passes sim-time along with the message. Downstream components do not immediately process received messages. Instead they have an input queue of messages, sorted by sim-time. A component can only progress forwards to time T once all it’s upstream components have passed it a message at or beyond time T. Once the component can reach time T, it can pop all messages at or before T from its input queues and process them.<p>Some other details that add complexity are:<ol><li>If component A runs and doesn’t send a message directly to its downstream component B, it should still pass along a clock signal so that B knows its clock can move forwards in time.<li>If you have a cycle in the component graph, you need some way to prevent the cycle from deadlocking.<li>You need some type of backpressure to prevent upstream components from flooding the message queues of downstream components.</ol><h1 id=what-software-to-use>What software to use<a aria-label="Anchor link for: what-software-to-use" class=zola-anchor href=#what-software-to-use style=visibility:hidden>#</a></h1><p>Unfortunately, I don’t know of any open source frameworks that provide determinism. ROS does not have this out of the box. Its message passing system is designed to run on the robot itself, so it delivers messages as quickly as possible and doesn’t try to achieve determinism. I have heard second-hand about companies having internal frameworks for achieving determinism in their simulations. Unfortunately none of these frameworks have been open sourced that I know of.</article></div><footer><div class=copyright><p>© 2024 Stu</div></footer></main></div><script src=/js/lightense.min.js></script><script src=/js/main.js></script>